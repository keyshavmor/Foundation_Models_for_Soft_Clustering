--- Starting Slurm Job ---
Job ID: 32599746
Running on host: eu-g5-037-3
Initial CWD: /cluster/home/maurdu/Foundation_models_NB/clustering
User: maurdu
Home: /cluster/home/maurdu
-----------------------------
Loading eth_proxy module...
eth_proxy module loaded. HTTP_PROXY=
-----------------------------
Setting up Conda...
Activating Conda environment: cancer_found
Conda environment activated: cancer_found
Python interpreter: /cluster/home/maurdu/miniconda/envs/cancer_found/bin/python
Python version: Python 3.9.21
PYTHONPATH: 
-----------------------------
Attempting to cd to: /cluster/home/maurdu/Foundation_models_NB/clustering
Successfully changed CWD. New CWD: /cluster/home/maurdu/Foundation_models_NB/clustering
-----------------------------
Checking if Python script exists: /cluster/home/maurdu/Foundation_models_NB/clustering/cancerfnd.py
-rw-r--r-- 1 maurdu maurdu-group 57K May 20 17:03 /cluster/home/maurdu/Foundation_models_NB/clustering/cancerfnd.py
Checking if Config file exists: /cluster/home/maurdu/Foundation_models_NB/clustering/config_concat_tumor.yaml
-rw-r--r-- 1 maurdu maurdu-group 5.2K May 17 18:55 /cluster/home/maurdu/Foundation_models_NB/clustering/config_concat_tumor.yaml
-----------------------------
Executing command: python -u -X faulthandler cancerfnd.py --config=config_concat_tumor.yaml
--- PYTHON SCRIPT cancerfnd.py STARTED --- CWD: /cluster/home/maurdu/Foundation_models_NB/clustering
--- PYTHON SCRIPT cancerfnd.py --- Python Executable: /cluster/home/maurdu/miniconda/envs/cancer_found/bin/python
--- PYTHON SCRIPT cancerfnd.py --- sys.path: ['/cluster/home/maurdu/Foundation_models_NB/clustering', '/cluster/home/maurdu/miniconda/envs/cancer_found/lib/python39.zip', '/cluster/home/maurdu/miniconda/envs/cancer_found/lib/python3.9', '/cluster/home/maurdu/miniconda/envs/cancer_found/lib/python3.9/lib-dynload', '/cluster/home/maurdu/miniconda/envs/cancer_found/lib/python3.9/site-packages']
--- Loading Configuration ---
Loaded configuration for: CancerFoundation_NB_Dataset3_Analysis
--- Setting up Paths and Scanpy ---
Scanpy figure directory set to: concat_tumor/results/scanpy_plots
--- Matplotlib plt.show() patched to save figures instead. ---
--- Loading/Generating CancerFoundation Embeddings ---
output_embedded_path is: resources/embeddings/embedding_processed.h5ad
Loading existing embedded AnnData: resources/embeddings/embedding_processed.h5ad
Load complete.
Found embedding key 'CancerGPT' in loaded data.

--- Embedded AnnData Object Info ---
AnnData object with n_obs × n_vars = 53315 × 1197
    obs: 'orig.ident', 'nCount_RNA', 'nFeature_RNA', 'percent_mito', 'Study', 'Assay', 'Platform', 'Sample', 'Patient_No', 'Timepoint', 'INSS_stage', 'MYCN_amplification', 'Gender', 'Risk', 'Cell_condition', 'Cell_type', 'cell', 'n_genes', 'leiden', 'cnv_leiden', 'cnv_score', 'cnv_status', 'Stage_Code', 'Tissue', 'Risk_Category', 'First_Avail_TP', 'MYCN_Status', 'ALK_Status', 'TP53_Status', 'Response', 'Vital_Status', 'Age_at_IDX_in_months', 'Treatment', 'First_Avail_Time_Point', 'sample_name', 'biospecimen_id', 'percent.mt', 'seurat_clusters', 'sample_label_wo_prefix', 'S.Score', 'G2M.Score', 'Phase', 'malignancy', 'cell_state', 'RNA_snn_res.0.2', 'MES_Score', 'ADRN_Score', 'MES_ADRN_diff', 'Event', 'organism_ontology_term_id', 'donor_id', 'development_stage_ontology_term_id', 'sex_ontology_term_id', 'disease_ontology_term_id', 'tissue_type', 'cell_type_ontology_term_id', 'assay_ontology_term_id', 'suspension_type', 'tissue_ontology_term_id', 'self_reported_ethnicity_ontology_term_id', 'is_primary_data', 'cell_type', 'assay', 'disease', 'organism', 'sex', 'tissue', 'self_reported_ethnicity', 'development_stage', 'observation_joinid', 'cell_type_joint', 'SAMPLES_JOINT'
    var: 'highly_variable', 'means', 'dispersions', 'dispersions_norm', 'genes', 'n_cells'
    uns: 'SAMPLES_JOINT_colors', 'Stage_Code_colors', 'X_umap_cfnd_bbknn', 'X_umap_cfnd_harmony', 'cell_state_colors', 'cell_type_joint_colors', 'hvg', 'log1p', 'neighbors'
    obsm: 'CancerGPT', 'X_pca', 'X_umap', 'X_umap_cfnd_bbknn', 'X_umap_cfnd_harmony', 'cancerfnd_pca', 'cancerfnd_pca_harmony', 'cancerfnd_z'
    obsp: 'connectivities', 'distances'
Embedding 'CancerGPT' shape: (53315, 256)
adata filtered for cells that have a ground truth value, retaining: (49131, 1197)

--- Calculating Neighbors and UMAP based on 'CancerGPT' ---
UMAP calculated and stored in adata.obsm['X_umap_cfnd_harmony']

==================================================
--- Running Clustering Algorithms ---
==================================================

--- Running Gaussian Mixture Model (GMM) ---
Calculating BIC/AIC for component selection...
  Fitting GMM with 2 components...
  Fitting GMM with 3 components...
  Fitting GMM with 4 components...
  Fitting GMM with 5 components...
  Fitting GMM with 6 components...
  Fitting GMM with 7 components...
  Fitting GMM with 8 components...
  Fitting GMM with 9 components...
  Fitting GMM with 10 components...
  Fitting GMM with 11 components...
  Fitting GMM with 12 components...
  Fitting GMM with 13 components...
  Fitting GMM with 14 components...
  Fitting GMM with 15 components...
  Fitting GMM with 16 components...
  Fitting GMM with 17 components...
  Fitting GMM with 18 components...
  Fitting GMM with 19 components...
  Fitting GMM with 20 components...
Optimal number of clusters based on BIC: 20
--- Plot Autosave: Saving plots to directory 'concat_tumor/results/autosaved_plots/' ---
Redirecting plt.show(): Saving figure 0 to concat_tumor/results/autosaved_plots/autosaved_plot_0.png
Fitting final GMM with 20 components...
Added 'GMM_probabilities' to obsm, 'GMM_entropy' and 'gmm_cluster' to obs.

--- Running K-Means Clustering (k=20) ---
Stored K-Means results in adata.obs['kmeans']

--- Running Leiden Clustering ---
Stored Leiden results in adata.obs['leiden']
Found 18 Leiden clusters.

--- Running Louvain Clustering ---
Stored Louvain results in adata.obs['louvain']
Found 16 Louvain clusters.
--- Clustering Finished ---
Updated adata object is:
AnnData object with n_obs × n_vars = 49131 × 1197
    obs: 'orig.ident', 'nCount_RNA', 'nFeature_RNA', 'percent_mito', 'Study', 'Assay', 'Platform', 'Sample', 'Patient_No', 'Timepoint', 'INSS_stage', 'MYCN_amplification', 'Gender', 'Risk', 'Cell_condition', 'Cell_type', 'cell', 'n_genes', 'leiden', 'cnv_leiden', 'cnv_score', 'cnv_status', 'Stage_Code', 'Tissue', 'Risk_Category', 'First_Avail_TP', 'MYCN_Status', 'ALK_Status', 'TP53_Status', 'Response', 'Vital_Status', 'Age_at_IDX_in_months', 'Treatment', 'First_Avail_Time_Point', 'sample_name', 'biospecimen_id', 'percent.mt', 'seurat_clusters', 'sample_label_wo_prefix', 'S.Score', 'G2M.Score', 'Phase', 'malignancy', 'cell_state', 'RNA_snn_res.0.2', 'MES_Score', 'ADRN_Score', 'MES_ADRN_diff', 'Event', 'organism_ontology_term_id', 'donor_id', 'development_stage_ontology_term_id', 'sex_ontology_term_id', 'disease_ontology_term_id', 'tissue_type', 'cell_type_ontology_term_id', 'assay_ontology_term_id', 'suspension_type', 'tissue_ontology_term_id', 'self_reported_ethnicity_ontology_term_id', 'is_primary_data', 'cell_type', 'assay', 'disease', 'organism', 'sex', 'tissue', 'self_reported_ethnicity', 'development_stage', 'observation_joinid', 'cell_type_joint', 'SAMPLES_JOINT', 'GMM_entropy', 'gmm_cluster', 'kmeans', 'louvain'
    var: 'highly_variable', 'means', 'dispersions', 'dispersions_norm', 'genes', 'n_cells'
    uns: 'SAMPLES_JOINT_colors', 'Stage_Code_colors', 'X_umap_cfnd_bbknn', 'X_umap_cfnd_harmony', 'cell_state_colors', 'cell_type_joint_colors', 'hvg', 'log1p', 'neighbors', 'donor_id_colors', 'leiden', 'louvain'
    obsm: 'CancerGPT', 'X_pca', 'X_umap_cfnd_bbknn', 'X_umap_cfnd_harmony', 'cancerfnd_pca', 'cancerfnd_pca_harmony', 'cancerfnd_z', 'GMM_probabilities'
    obsp: 'connectivities', 'distances'

==================================================
--- Generating Visualizations ---
==================================================

Scanpy plots will be saved to: /cluster/home/maurdu/Foundation_models_NB/clustering/clustering/concat_tumor/clustering_plots
Scanpy plot file format: png
Plotting UMAPs based on 'X_umap_cfnd_harmony' and saving to 'clustering/concat_tumor/clustering_plots'...
Plotting UMAP colored by 'cell_state', saving with suffix 'cell_state'...
Plotting UMAP colored by 'donor_id', saving with suffix 'donor_id'...
Plotting UMAP colored by 'Stage_Code', saving with suffix 'Stage_Code'...
Plotting UMAP colored by 'leiden', saving with suffix 'leiden'...
Plotting UMAP colored by 'louvain', saving with suffix 'louvain'...
Plotting UMAP colored by 'gmm_cluster', saving with suffix 'gmm_cluster'...
Plotting UMAP colored by 'kmeans', saving with suffix 'kmeans'...
Plotting UMAP colored by GMM Entropy, saving with suffix '_GMM_entropy.png'...

==================================================
--- Visualization Generation and Saving Complete ---
--- Plots have been saved in: /cluster/home/maurdu/Foundation_models_NB/clustering/clustering/concat_tumor/clustering_plots ---
==================================================


==================================================
--- Evaluating Clustering vs 'cell_state' ---
==================================================

--- 1. Calculating Evaluation Metrics ---
Evaluating: leiden
  ARI: 0.0479, NMI: 0.2065, Homogeneity: 0.3189, Completeness: 0.1527, V-Measure: 0.2065, Silhouette: -0.0367
Evaluating: louvain
  ARI: 0.0551, NMI: 0.2066, Homogeneity: 0.3101, Completeness: 0.1549, V-Measure: 0.2066, Silhouette: -0.0321
Evaluating: gmm_cluster
  ARI: 0.0485, NMI: 0.2117, Homogeneity: 0.3680, Completeness: 0.1486, V-Measure: 0.2117, Silhouette: 0.1367
Evaluating: kmeans
  ARI: 0.0520, NMI: 0.2106, Homogeneity: 0.3607, Completeness: 0.1487, V-Measure: 0.2106, Silhouette: 0.1510

--- Metrics Summary ---
|             |    ARI |    NMI |   Homogeneity |   Completeness |   V-Measure |   Silhouette |
|:------------|-------:|-------:|--------------:|---------------:|------------:|-------------:|
| leiden      | 0.0479 | 0.2065 |        0.3189 |         0.1527 |      0.2065 |      -0.0367 |
| louvain     | 0.0551 | 0.2066 |        0.3101 |         0.1549 |      0.2066 |      -0.0321 |
| gmm_cluster | 0.0485 | 0.2117 |        0.3680 |         0.1486 |      0.2117 |       0.1367 |
| kmeans      | 0.0520 | 0.2106 |        0.3607 |         0.1487 |      0.2106 |       0.1510 |
-------------------------
Metrics saved to concat_tumor/results/evaluation_plots/clustering_metrics.csv

--- 2. Generating Confusion Matrices ---
Generating Confusion Matrix for: leiden
Saved confusion matrix to concat_tumor/results/evaluation_plots/confusion_matrix_leiden_vs_cell_state.png
Generating Confusion Matrix for: louvain
Saved confusion matrix to concat_tumor/results/evaluation_plots/confusion_matrix_louvain_vs_cell_state.png
Generating Confusion Matrix for: gmm_cluster
Saved confusion matrix to concat_tumor/results/evaluation_plots/confusion_matrix_gmm_cluster_vs_cell_state.png
Generating Confusion Matrix for: kmeans
Saved confusion matrix to concat_tumor/results/evaluation_plots/confusion_matrix_kmeans_vs_cell_state.png

--- 3. Generating Cluster Composition Plots ---
Generating Composition Plot for: leiden
Saved composition plot to concat_tumor/results/evaluation_plots/composition_plot_leiden.png
Generating Composition Plot for: louvain
Saved composition plot to concat_tumor/results/evaluation_plots/composition_plot_louvain.png
Generating Composition Plot for: gmm_cluster
Saved composition plot to concat_tumor/results/evaluation_plots/composition_plot_gmm_cluster.png
Generating Composition Plot for: kmeans
Saved composition plot to concat_tumor/results/evaluation_plots/composition_plot_kmeans.png

==================================================
--- Running scIB Benchmark ---
==================================================

Benchmarking embeddings: ['CancerGPT', 'cancerfnd_pca', 'cancerfnd_pca_harmony', 'X_umap_cfnd_harmony']
Using label key: 'cell_state' and batch key: 'donor_id'
Plotting scIB results table...
Redirecting plt.show(): Saving figure 1 to concat_tumor/results/autosaved_plots/autosaved_plot_1.png

--- scIB Benchmark Results ---
| Embedding             | Isolated labels    | Leiden NMI          | Leiden ARI           | Silhouette label   | cLISI              | Silhouette batch   | iLISI                 | KBET                | Graph connectivity   | PCR comparison      | Batch correction    | Bio conservation    | Total               |
|:----------------------|:-------------------|:--------------------|:---------------------|:-------------------|:-------------------|:-------------------|:----------------------|:--------------------|:---------------------|:--------------------|:--------------------|:--------------------|:--------------------|
| CancerGPT             | 0.5356543660163879 | 0.19308255325975957 | 0.03416485709822652  | 0.4970581610687077 | 0.961910891532898  | 0.8327010273933411 | 0.0016813732328869048 | 0.14202322412945892 | 0.8025461604190346   | 0.12186206554598876 | 0.380162770144142   | 0.4443741657951959  | 0.41868960753477436 |
| cancerfnd_pca         | 0.5410012602806091 | 0.1932497775479808  | 0.026658723948848273 | 0.4991526392986998 | 0.960192060470581  | 0.8291578888893127 | 0.0017394451867966424 | 0.14868595520749164 | 0.7789480226874589   | 0.1306026667375349  | 0.37782679574171896 | 0.44405089230934386 | 0.4175612536822939  |
| cancerfnd_pca_harmony | 0.5121761560440063 | 0.24658542513141998 | 0.22934473532048238  | 0.5003367511671968 | 0.9287421941757202 | 0.8675560355186462 | 0.1695143154689244    | 0.3411515010676995  | 0.6702921312567663   | 0.8579869924784925  | 0.5813001951581058  | 0.48343705236776513 | 0.5225823094839014  |
| X_umap_cfnd_harmony   | 0.7027498483657837 | 0.44856350934102884 | 0.08900543071739891  | 0.6929981410503387 | 0.9999999046325684 | 0.6692492961883545 | 0.24862500599452428   | 0.35347170200396505 | 0.9523187014696397   | 0.7199921589702647  | 0.5887313729253497  | 0.5866633668214237  | 0.5874905692629941  |
| Metric Type           | Bio conservation   | Bio conservation    | Bio conservation     | Bio conservation   | Bio conservation   | Batch correction   | Batch correction      | Batch correction    | Batch correction     | Batch correction    | Aggregate score     | Aggregate score     | Aggregate score     |
-----------------------------
Python script finished with exit code: 1
Listing files in CWD (/cluster/home/maurdu/Foundation_models_NB/clustering) after script execution:
total 183M
drwxr-xr-x  8 maurdu maurdu-group 4.0K May 20 14:17 .
drwxr-xr-x 12 maurdu maurdu-group 4.0K May 17 18:14 ..
-rw-r--r--  1 maurdu maurdu-group  555 May 15 09:21 bench_NBatlas.sh
-rw-r--r--  1 maurdu maurdu-group  551 May 15 12:03 bench_tumor.sh
-rw-r--r--  1 maurdu maurdu-group  42K May 15 16:43 cancerfnd_a.py
-rw-r--r--  1 maurdu maurdu-group  57K May 20 17:03 cancerfnd.py
drwxr-xr-x  3 maurdu maurdu-group 4.0K May 17 20:24 clustering
-rw-r--r--  1 maurdu maurdu-group  43K May 20 14:17 clustering_benchmarking.py
drwxr-xr-x  2 maurdu maurdu-group 4.0K May 20 14:29 concat
-rw-r--r--  1 maurdu maurdu-group 3.1K May 16 17:20 concat_cl.err
-rw-r--r--  1 maurdu maurdu-group  11K May 16 17:20 concat_cl.out
drwxr-xr-x  3 maurdu maurdu-group 4.0K May 20 14:42 concat_tumor
-rw-r--r--  1 maurdu maurdu-group 5.1K May 16 15:27 config_concat_a.yaml
-rw-r--r--  1 maurdu maurdu-group 5.2K May 17 18:55 config_concat_tumor.yaml
-rw-r--r--  1 maurdu maurdu-group 5.2K May 17 19:08 config_concat.yaml
-rw-r--r--  1 maurdu maurdu-group 5.3K May 15 16:02 config_NBatlas.yaml
-rw-r--r--  1 maurdu maurdu-group 5.1K May 15 16:00 config_sn_tumor.yaml
-rw-r--r--  1 maurdu maurdu-group 2.6K May 15 12:10 debug_atlas.sh
-rw-r--r--  1 maurdu maurdu-group 2.6K May 15 16:52 debug_concat_a.sh
-rw-r--r--  1 maurdu maurdu-group 2.6K May 16 13:11 debug_concat.sh
-rw-r--r--  1 maurdu maurdu-group 2.6K May 17 11:46 debug_concat_tumor.sh
-rw-r--r--  1 maurdu maurdu-group 2.6K May 15 12:08 debug_tumor.sh
-rw-r--r--  1 maurdu maurdu-group 182M May 20 18:42 midpoint_save.h5ad
drwxr-xr-x  3 maurdu maurdu-group 4.0K Apr 29 14:46 resources
drwxr-xr-x  8 maurdu maurdu-group 4.0K May 15 18:38 results
drwxr-xr-x  3 maurdu maurdu-group 4.0K May 17 12:39 tumor
-rw-r--r--  1 maurdu maurdu-group  22K May 20 19:30 tumor.err
-rw-r--r--  1 maurdu maurdu-group  15K May 20 19:30 tumor.out
--- Slurm Job Ended ---
