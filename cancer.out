--- Matplotlib plt.show() patched to save figures instead. ---
Loading existing embedded AnnData: /cluster/home/maurdu/Foundation_models_NB/notebooks/../data/NB.bone.Met_embedded.h5ad
Load complete.

--- Final Embedded AnnData Object Info ---
AnnData object with n_obs × n_vars = 36763 × 1199
    obs: 'cell1', 'cell2', 'fraction', 'sample', 'cell_ID', 'n_genes', 'leiden'
    var: 'hgnc_symbol', 'ensembl_gene_id', 'gene_biotype', 'n_cells', 'mean', 'std', 'genes', 'id_in_vocab', 'highly_variable', 'means', 'dispersions', 'dispersions_norm', 'highly_variable_nbatches', 'highly_variable_intersection'
    uns: 'hvg', 'leiden', 'neighbors', 'pca', 'umap'
    obsm: 'CancerGPT', 'X_pca', 'X_umap'
    varm: 'PCs'
    layers: 'RNA', 'log1p_norm'
    obsp: 'connectivities', 'distances'
Using embeddings from embed_adata.obsm['CancerGPT'] with shape: (36763, 256)

--- Calculating BIC/AIC for GMM component selection ---
Fitting GMM with 2 components...
Fitting GMM with 3 components...
Fitting GMM with 4 components...
Fitting GMM with 5 components...
Fitting GMM with 6 components...
Fitting GMM with 7 components...
Fitting GMM with 8 components...
Fitting GMM with 9 components...
Fitting GMM with 10 components...
Fitting GMM with 11 components...
Fitting GMM with 12 components...
Fitting GMM with 13 components...
Fitting GMM with 14 components...
Fitting GMM with 15 components...
Fitting GMM with 16 components...
Fitting GMM with 17 components...
Fitting GMM with 18 components...
Fitting GMM with 19 components...
Fitting GMM with 20 components...
Finished calculating BIC/AIC scores.
Plotting BIC/AIC scores...
--- Plot Autosave: Saving plots to directory 'autosaved_plots' ---
Redirecting plt.show(): Saving figure 0 to autosaved_plots/autosaved_plot_0.png

--- Proceeding with GMM fitting using 20 components ---
Fitting final GMM with 20 components...
Calculating entropy...
Added 'GMM_probabilities' to embed_adata.obsm
Added 'GMM_entropy' to embed_adata.obs
Added 'GMM_cluster' (dominant cluster) to embed_adata.obs

Done with GMM and entropy calculation.

--- Starting Visualization (using embedding: 'X_umap') ---
Plotting dominant GMM clusters on X_umap...
Plotting GMM entropy on X_umap...
Plotting clusters and entropy side-by-side on X_umap...
Ground truth key 'ground_truth' not found in embed_adata.obs. Skipping ground truth plot.

--- Analysis Complete ---
Eigengap heuristic suggests n_clusters=2 for Clustering.
Running K-Means with 2 clusters on embeddings...
Stored K-Means results in embed_adata.obs['kmeans']
Running Louvain clustering...
Stored Louvain results in embed_adata.obs['louvain']
Found 17 Louvain clusters.
Running Leiden clustering...
Stored Leiden results in embed_adata.obs['leiden']
Found 22 Leiden clusters.
Running HDBSCAN...
Using min_cluster_size=10 for HDBSCAN.
HDBSCAN found 11 actual clusters and 35767 points were labeled as noise (-1).
Stored HDBSCAN results in embed_adata.obs['HDBSCAN'].
Running OPTICS...
Using min_samples=7 for OPTICS.
OPTICS found 16 clusters (excluding noise -1).
Stored OPTICS results in embed_adata.obs['OPTICS'].
Estimated bandwidth: 0.041
Running MeanShift...
MeanShift found 927 clusters.
Stored MeanShift results in embed_adata.obs['Mean_Shift'].
Stored Spectral Clustering results in embed_adata.obs['spectral']

Saving embedded AnnData object to: ./cluster_res/clustered_adata.h5ad
Save complete.

==================================================
--- Starting Evaluation Against Known Cell Labels ---
==================================================


--- 1. Clustering Evaluation Metrics (vs 'cell2') ---

Evaluating: GMM_cluster
  Adjusted Rand Index (ARI): 0.0995
  Normalized Mutual Info (NMI): 0.2663
  Homogeneity: 0.2300
  Completeness: 0.3163
  V-Measure: 0.2663

Evaluating: kmeans
  Adjusted Rand Index (ARI): 0.0058
  Normalized Mutual Info (NMI): 0.0396
  Homogeneity: 0.0207
  Completeness: 0.4753
  V-Measure: 0.0396

Evaluating: louvain
  Adjusted Rand Index (ARI): 0.1259
  Normalized Mutual Info (NMI): 0.2982
  Homogeneity: 0.2734
  Completeness: 0.3280
  V-Measure: 0.2982

Evaluating: leiden
  Adjusted Rand Index (ARI): 0.1353
  Normalized Mutual Info (NMI): 0.2992
  Homogeneity: 0.2912
  Completeness: 0.3077
  V-Measure: 0.2992

Evaluating: HDBSCAN
  Adjusted Rand Index (ARI): 0.0040
  Normalized Mutual Info (NMI): 0.0440
  Homogeneity: 0.0232
  Completeness: 0.4143
  V-Measure: 0.0440

Evaluating: OPTICS
  Adjusted Rand Index (ARI): 0.0003
  Normalized Mutual Info (NMI): 0.0070
  Homogeneity: 0.0035
  Completeness: 0.2130
  V-Measure: 0.0070

Evaluating: Mean_Shift
  Adjusted Rand Index (ARI): 0.0399
  Normalized Mutual Info (NMI): 0.2322
  Homogeneity: 0.1637
  Completeness: 0.3990
  V-Measure: 0.2322

Evaluating: spectral
  Adjusted Rand Index (ARI): 0.0057
  Normalized Mutual Info (NMI): 0.0393
  Homogeneity: 0.0205
  Completeness: 0.4743
  V-Measure: 0.0393

--- Metrics Summary ---
                  ARI       NMI  Homogeneity  Completeness  V-Measure
GMM_cluster  0.099499  0.266324     0.229963      0.316343   0.266324
kmeans       0.005751  0.039643     0.020684      0.475264   0.039643
louvain      0.125900  0.298223     0.273390      0.328019   0.298223
leiden       0.135285  0.299190     0.291161      0.307674   0.299190
HDBSCAN      0.003986  0.043989     0.023228      0.414336   0.043989
OPTICS       0.000314  0.006954     0.003535      0.213048   0.006954
Mean_Shift   0.039858  0.232198     0.163748      0.398980   0.232198
spectral     0.005700  0.039257     0.020476      0.474320   0.039257
-------------------------

--- 2. Confusion Matrices (True Labels vs Predicted Clusters) ---

Generating Confusion Matrix for: GMM_cluster

Generating Confusion Matrix for: kmeans

Generating Confusion Matrix for: louvain

Generating Confusion Matrix for: leiden

Generating Confusion Matrix for: HDBSCAN

Generating Confusion Matrix for: OPTICS

Generating Confusion Matrix for: Mean_Shift

Generating Confusion Matrix for: spectral
Redirecting plt.show(): Saving figure 1 to autosaved_plots/autosaved_plot_1.png

--- 3. Cluster Composition Bar Plots ---

Generating Composition Plot for: GMM_cluster
Redirecting plt.show(): Saving figure 2 to autosaved_plots/autosaved_plot_2.png

Generating Composition Plot for: kmeans
Redirecting plt.show(): Saving figure 3 to autosaved_plots/autosaved_plot_3.png

Generating Composition Plot for: louvain
Redirecting plt.show(): Saving figure 4 to autosaved_plots/autosaved_plot_4.png

Generating Composition Plot for: leiden
Redirecting plt.show(): Saving figure 5 to autosaved_plots/autosaved_plot_5.png

Generating Composition Plot for: HDBSCAN
Redirecting plt.show(): Saving figure 6 to autosaved_plots/autosaved_plot_6.png

Generating Composition Plot for: OPTICS
Redirecting plt.show(): Saving figure 7 to autosaved_plots/autosaved_plot_7.png

Generating Composition Plot for: Mean_Shift
Redirecting plt.show(): Saving figure 8 to autosaved_plots/autosaved_plot_8.png

Generating Composition Plot for: spectral
Redirecting plt.show(): Saving figure 9 to autosaved_plots/autosaved_plot_9.png

--- 4. GMM Entropy Distribution per 'cell2' Label ---
Redirecting plt.show(): Saving figure 10 to autosaved_plots/autosaved_plot_10.png

Interpretation Guide (?):
- Higher entropy for a cell indicates it has similar probabilities of belonging to multiple GMM clusters (more uncertainty/ambiguity).
- Lower entropy indicates the cell is strongly assigned to one GMM cluster.
- Examining entropy distribution within known 'cell2' groups can reveal:
  - Groups with consistently low entropy: Likely well-separated and confidently clustered by GMM.
  - Groups with consistently high entropy: May represent intermediate states, poorly separated populations, or areas where GMM struggles.
  - Groups with wide entropy variance: Might contain subpopulations with different clustering certainties.

==================================================
--- Evaluation Complete ---
==================================================

Redirecting plt.show(): Saving figure 11 to autosaved_plots/autosaved_plot_11.png
